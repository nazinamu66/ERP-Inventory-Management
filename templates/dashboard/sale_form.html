{% extends 'dashboard/base.html' %}
{% block title %}Record Sale{% endblock %}

{% block content %}
<h3>New Sale</h3>

<form method="POST" novalidate>
    {% csrf_token %}
    {{ formset.management_form }}
    <input type="hidden" name="form-TOTAL_FORMS" id="id_form-TOTAL_FORMS" value="{{ formset.total_form_count|default:1 }}">
    <input type="hidden" name="grand_total" id="id_grand_total" value="0.00">

    <div id="formset-meta" data-form-count="{{ formset.total_form_count|default:0 }}"></div>

    <!-- SALE DETAILS -->
    <div class="card mb-4 p-3">
        <h5>Sale Info</h5>

        <div class="mb-3">
            <label>Receipt Number</label>
            <input type="text" class="form-control" 
                   value="{{ form.instance.receipt_number|default:'(Will be generated after save)' }}" readonly>
        </div>

        {% for field in form %}
        <div class="mb-3">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <div class="text-danger">{{ field.errors }}</div>
            {% endif %}
        </div>
        {% endfor %}

        <div class="mb-3" id="bank-wrapper" style="display: none;">
            <label for="id_bank">Bank</label>
            {{ form.bank }}
        </div>
    </div>

    <!-- SALE ITEMS -->
    <div class="card mb-4 p-3">
        <h5>Items</h5>

        <div id="items-container">
            {% for form in formset %}
            <div class="border rounded p-3 mb-3 bg-light formset-item">
                <div class="row">
                    {% for field in form.visible_fields %}
                    <div class="col-md-4 mb-2">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                        <div class="text-danger">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Hidden Template -->
        <template id="empty-form-template">
            <div class="border rounded p-3 mb-3 bg-light formset-item">
                <div class="row">
                    {% for field in formset.empty_form.visible_fields %}
                    <div class="col-md-4 mb-2">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
                    </div>
                </div>
            </div>
        </template>

        <div class="text-end mb-3">
            <button type="button" class="btn btn-outline-primary" id="add-item-btn">Add Item</button>
        </div>

        <div class="text-end mt-2">
            <strong>Total:</strong> â‚¹ <span id="grand-total">0.00</span>
        </div>
    </div>

    <button type="submit" class="btn btn-success">Submit Sale</button>
</form>

<!-- Stock Info -->
<div id="stock-info" class="alert alert-info d-none mt-4">
    <strong>Current Stock:</strong> <span id="stock-value">-</span>
</div>

<!-- JavaScript Logic -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const paymentMethod = document.getElementById('id_payment_method');
    const bankWrapper = document.getElementById('bank-wrapper');
    const bankSelect = document.getElementById('id_bank');
    const storeField = document.getElementById('id_store');
    const stockInfo = document.getElementById('stock-info');
    const stockValue = document.getElementById('stock-value');
    const totalSpan = document.getElementById('grand-total');
    const totalInput = document.getElementById('id_grand_total');
    const formsetPrefix = 'form';
    let formIdx = parseInt(document.getElementById('formset-meta').dataset.formCount || 0);
    const formContainer = document.getElementById('items-container');

    function toggleBankField() {
        if (paymentMethod?.value === 'bank_transfer') {
            bankWrapper.style.display = 'block';
        } else {
            bankWrapper.style.display = 'none';
            if (bankSelect) bankSelect.value = '';
        }
    }

    if (paymentMethod) {
        paymentMethod.addEventListener('change', toggleBankField);
        toggleBankField();
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.formset-item').forEach(item => {
            const qty = parseFloat(item.querySelector('[id$="-quantity"]')?.value || 0);
            const price = parseFloat(item.querySelector('[id$="-unit_price"]')?.value || 0);
            if (!isNaN(qty) && !isNaN(price)) {
                total += qty * price;
            }
        });
        totalSpan.textContent = total.toFixed(2);
        totalInput.value = total.toFixed(2);
    }

    function fetchStock(productField) {
        const productId = productField.value;
        const storeId = storeField?.value;
        if (!productId || !storeId) return stockInfo.classList.add('d-none');

        fetch(`/dashboard/api/get-stock/?product_id=${productId}&store_id=${storeId}`)
            .then(res => res.json())
            .then(data => {
                stockValue.textContent = data.quantity;
                stockInfo.classList.remove('d-none');
            })
            .catch(() => {
                stockValue.textContent = 'Error';
                stockInfo.classList.remove('d-none');
            });
    }

    function attachListeners(scope) {
        scope.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', updateTotal);
        });
        scope.querySelectorAll('[id$="-product"]').forEach(productField => {
            productField.addEventListener('change', () => fetchStock(productField));
        });
    }

    document.querySelectorAll('.formset-item').forEach(attachListeners);

    document.getElementById('add-item-btn').addEventListener('click', () => {
        const template = document.getElementById('empty-form-template').innerHTML;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = template.replace(/__prefix__/g, formIdx);
        const newForm = wrapper.firstElementChild;
        formContainer.appendChild(newForm);
        document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`).value = ++formIdx;
        attachListeners(newForm);
        updateTotal();
    });

    formContainer.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-item')) {
            const item = e.target.closest('.formset-item');
            if (item) {
                item.remove();
                updateTotal();
                formIdx--;
                document.getElementById('id_form-TOTAL_FORMS').value = formIdx;
            }
        }
    });

    storeField?.addEventListener('change', () => {
        document.querySelectorAll('[id^="id_form-"][id$="-product"]').forEach(fetchStock);
    });

    updateTotal();
});
</script>

{% endblock %}
